<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タスクスケジューラー</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .task-row {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .time-bar {
            height: 60px;
            position: relative;
            border: 2px solid #333;
            border-radius: 4px;
            margin-top: 20px;
            background-color: white;
        }

        .time-segment {
            height: 100%;
            display: inline-block;
            position: relative;
        }

        .time-label {
            position: absolute;
            top: -25px;
            font-size: 10px;
            white-space: nowrap;
            color: #666;
        }

        .break-segment {
            background-color: #cccccc !important;
        }

        .percentage-input {
            width: 80px;
        }

        .task-colors {
            --color-1: #ff6b6b;
            --color-2: #4ecdc4;
            --color-3: #45b7d1;
            --color-4: #96ceb4;
            --color-5: #feca57;
            --color-6: #ff9ff3;
            --color-7: #54a0ff;
            --color-8: #5f27cd;
        }

        .break-time-row {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4">タスクスケジューラー</h1>

        <!-- 上部：タスク管理セクション -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>タスク管理</h3>
            </div>
            <div class="card-body">
                <div id="task-list">
                    <!-- タスク行がここに動的に追加される -->
                </div>
                <button type="button" class="btn btn-primary" onclick="addTask()">
                    <i class="bi bi-plus"></i> タスクを追加
                </button>
                <div class="mt-3">
                    <strong>合計割合: <span id="total-percentage">0</span>%</strong>
                    <div class="progress mt-2">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 下部：時間設定と可視化セクション -->
        <div class="card">
            <div class="card-header">
                <h3>時間設定と可視化</h3>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="start-time" class="form-label">開始時刻</label>
                        <input type="time" class="form-control" id="start-time" value="09:00"
                            onchange="updateVisualization()">
                    </div>
                    <div class="col-md-3">
                        <label for="end-time" class="form-label">終了時刻</label>
                        <input type="time" class="form-control" id="end-time" value="17:00"
                            onchange="updateVisualization()">
                    </div>
                </div>

                <div class="mb-3">
                    <h5>休憩時間</h5>
                    <div id="break-times">
                        <!-- 休憩時間行がここに動的に追加される -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addBreakTime()">
                        休憩時間を追加
                    </button>
                </div>

                <!-- 時間バー可視化 -->
                <div class="mt-4">
                    <h5>時間割可視化</h5>
                    <div id="time-bar" class="time-bar">
                        <!-- 時間セグメントがここに動的に生成される -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let taskCount = 0;
        let breakCount = 0;
        let tasks = [];

        // 色の配列
        // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
        const colors = ['#ff8a80', '#ffc670', '#68b2ee', '#5e28dc', '#f42f77', '#ff8a80', '#ffc670', '#68b2ee'];

        function addTask() {
            taskCount++;
            const taskId = `task-${taskCount}`;
            const color = colors[(taskCount - 1) % colors.length];

            // 新しいタスクの初期割合を計算
            const currentTotal = tasks.reduce((sum, task) => sum + task.percentage, 0);
            const initialPercentage = Math.max(0, 100 - currentTotal);

            const taskHtml = `
                <div class="task-row" id="${taskId}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label">タスク名</label>
                            <input type="text" class="form-control" placeholder="タスク名を入力" onchange="updateVisualization()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">時間割合 (%)</label>
                            <div class="d-flex">
                                <input type="range" class="form-range me-2" min="0" max="100" value="${initialPercentage}" 
                                       oninput="updatePercentageInput(this, '${taskId}')" onchange="autoAdjustPercentages('${taskId}')">
                                <input type="number" class="form-control percentage-input" min="0" max="100" value="${initialPercentage}"
                                       oninput="updatePercentageSlider(this, '${taskId}')" onchange="autoAdjustPercentages('${taskId}')">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mt-4">
                                <div style="width: 30px; height: 30px; background-color: ${color}; border-radius: 4px; display: inline-block;"></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mt-4">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeTask('${taskId}')">削除</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('task-list').insertAdjacentHTML('beforeend', taskHtml);

            tasks.push({
                id: taskId,
                name: '',
                percentage: initialPercentage,
                color: color
            });

            updateTotalPercentage();
        }

        function removeTask(taskId) {
            document.getElementById(taskId).remove();
            tasks = tasks.filter(task => task.id !== taskId);
            updateTotalPercentage();
            updateVisualization();
            taskCount--;
        }

        function updatePercentageInput(slider, taskId) {
            const taskRow = document.getElementById(taskId);
            const input = taskRow.querySelector('input[type="number"]');
            input.value = slider.value;
            updateTaskData(taskId);
        }

        function updatePercentageSlider(input, taskId) {
            const taskRow = document.getElementById(taskId);
            const slider = taskRow.querySelector('input[type="range"]');
            slider.value = input.value;
            updateTaskData(taskId);
        }

        function updateTaskData(taskId) {
            const taskRow = document.getElementById(taskId);
            const nameInput = taskRow.querySelector('input[type="text"]');
            const percentageInput = taskRow.querySelector('input[type="number"]');

            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.name = nameInput.value;
                task.percentage = parseInt(percentageInput.value) || 0;
            }

            updateTotalPercentage();
            updateVisualization();
        }

        function autoAdjustPercentages(changedTaskId) {
            // 変更されたタスクの新しい値を取得
            const changedTaskRow = document.getElementById(changedTaskId);
            const changedValue = parseInt(changedTaskRow.querySelector('input[type="number"]').value) || 0;

            // 全タスクの順序を取得
            const allTaskRows = Array.from(document.querySelectorAll('.task-row'));
            const changedTaskIndex = allTaskRows.findIndex(row => row.id === changedTaskId);

            // 現在の合計を計算
            let currentTotal = 0;
            allTaskRows.forEach(row => {
                const input = row.querySelector('input[type="number"]');
                currentTotal += parseInt(input.value) || 0;
            });

            const difference = currentTotal - 100;

            if (difference !== 0) {
                // 変更されたタスクより後のタスクで、割合が0でない最初のタスクを見つける
                let targetTask = null;

                for (let i = changedTaskIndex + 1; i < allTaskRows.length; i++) {
                    const input = allTaskRows[i].querySelector('input[type="number"]');
                    const value = parseInt(input.value) || 0;
                    if (value > 0) {
                        targetTask = { row: allTaskRows[i], input: input, value: value };
                        break;
                    }
                }

                // 後のタスクに適切なものがない場合は調整しない（上部のタスクは変更しない）

                // 調整を実行
                if (targetTask) {
                    const newValue = Math.max(0, targetTask.value - difference);
                    targetTask.input.value = newValue;
                    const slider = targetTask.row.querySelector('input[type="range"]');
                    slider.value = newValue;
                }
            }

            updateTotalPercentage();
        }

        function updateTotalPercentage() {
            let total = 0;

            document.querySelectorAll('.task-row').forEach(row => {
                const input = row.querySelector('input[type="number"]');
                total += parseInt(input.value) || 0;
            });

            document.getElementById('total-percentage').textContent = total;
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = total + '%';
            progressBar.className = `progress-bar bg-success`;

            // タスクデータを更新
            tasks.forEach(task => {
                const taskRow = document.getElementById(task.id);
                if (taskRow) {
                    const percentageInput = taskRow.querySelector('input[type="number"]');
                    task.percentage = parseInt(percentageInput.value) || 0;
                }
            });

            updateVisualization();
        }

        function addBreakTime() {
            breakCount++;
            const breakId = `break-${breakCount}`;

            const breakHtml = `
                <div class="break-time-row" id="${breakId}">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label class="form-label">休憩開始</label>
                            <input type="time" class="form-control" value="12:00" onchange="updateVisualization()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">休憩終了</label>
                            <input type="time" class="form-control" value="13:00" onchange="updateVisualization()">
                        </div>
                        <div class="col-md-2">
                            <div class="mt-4">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeBreakTime('${breakId}')">削除</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('break-times').insertAdjacentHTML('beforeend', breakHtml);
            // DOM更新後に可視化を更新
            setTimeout(updateVisualization, 0);
        }

        function removeBreakTime(breakId) {
            document.getElementById(breakId).remove();
            updateVisualization();
        }

        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function updateVisualization() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            const totalMinutes = endMinutes - startMinutes;

            if (totalMinutes <= 0) return;

            // 休憩時間を取得
            const breaks = [];
            console.log("Checking break times...");
            document.querySelectorAll('.break-time-row').forEach((row, index) => {
                console.log(`Break row ${index}:`, row);
                const timeInputs = row.querySelectorAll('input[type="time"]');
                const startInput = timeInputs[0];
                const endInput = timeInputs[1];
                console.log("Start input:", startInput, "End input:", endInput);

                if (startInput && endInput) {
                    const breakStart = timeToMinutes(startInput.value);
                    const breakEnd = timeToMinutes(endInput.value);
                    console.log(`Break time: ${breakStart} - ${breakEnd}`);

                    if (breakStart >= startMinutes && breakEnd <= endMinutes && breakStart < breakEnd) {
                        breaks.push({ start: breakStart, end: breakEnd });
                        console.log("Break added:", { start: breakStart, end: breakEnd });
                    }
                }
            });
            console.log("Total breaks found:", breaks.length);

            // 休憩時間をソート
            breaks.sort((a, b) => a.start - b.start);

            // 時間バーの生成
            const timeBar = document.getElementById('time-bar');
            timeBar.innerHTML = '';

            // 開始時刻ラベルを追加
            const startLabel = document.createElement('div');
            startLabel.className = 'time-label';
            startLabel.style.left = '0px';
            startLabel.style.color = '#333';
            startLabel.style.fontWeight = 'bold';
            startLabel.textContent = minutesToTime(startMinutes);
            timeBar.appendChild(startLabel);

            // 終了時刻ラベルを追加
            const endLabel = document.createElement('div');
            endLabel.className = 'time-label';
            endLabel.style.right = '0px';
            endLabel.style.left = 'auto';
            endLabel.style.color = '#333';
            endLabel.style.fontWeight = 'bold';
            endLabel.textContent = minutesToTime(endMinutes);
            timeBar.appendChild(endLabel);

            // 作業時間を計算
            let workMinutes = totalMinutes;
            breaks.forEach(breakTime => {
                workMinutes -= (breakTime.end - breakTime.start);
            });

            // 作業時間のセグメントを作成
            const workPeriods = [];
            let currentStart = startMinutes;

            breaks.forEach(breakTime => {
                if (currentStart < breakTime.start) {
                    workPeriods.push({
                        start: currentStart,
                        end: breakTime.start
                    });
                }
                currentStart = breakTime.end;
            });

            // 最後の作業時間
            if (currentStart < endMinutes) {
                workPeriods.push({
                    start: currentStart,
                    end: endMinutes
                });
            }

            // 各タスクの時間を計算
            const taskTimes = tasks.map(task => ({
                ...task,
                minutes: Math.round(workMinutes * task.percentage / 100)
            }));

            // タスクを作業時間に割り当て
            let taskIndex = 0;
            let remainingTaskMinutes = taskTimes.length > 0 ? taskTimes[0].minutes : 0;
            let currentWorkMinute = 0;

            workPeriods.forEach(period => {
                const periodDuration = period.end - period.start;
                let periodStart = period.start;
                let remainingPeriodMinutes = periodDuration;
                let loopCounter = 0; // 無限ループ防止

                while (remainingPeriodMinutes > 0 && taskIndex < taskTimes.length && loopCounter < 1000) {
                    loopCounter++;
                    const task = taskTimes[taskIndex];
                    const minutesToUse = Math.min(remainingTaskMinutes, remainingPeriodMinutes);

                    if (minutesToUse > 0) {
                        const startPosition = ((periodStart - startMinutes) / totalMinutes) * 100;
                        const width = (minutesToUse / totalMinutes) * 100;

                        const segment = document.createElement('div');
                        segment.className = 'time-segment';
                        segment.style.position = 'absolute';
                        segment.style.left = startPosition + '%';
                        segment.style.width = width + '%';
                        segment.style.height = '100%';
                        segment.style.backgroundColor = task.color;

                        // タスクの終了時刻ラベルを右端に追加
                        const endTimeLabel = document.createElement('div');
                        endTimeLabel.className = 'time-label';
                        endTimeLabel.style.right = '0px';
                        endTimeLabel.style.left = 'auto';
                        endTimeLabel.style.color = '#333';
                        endTimeLabel.style.fontSize = '10px';
                        endTimeLabel.textContent = minutesToTime(periodStart + minutesToUse);
                        segment.appendChild(endTimeLabel);

                        timeBar.appendChild(segment);

                        periodStart += minutesToUse;
                        remainingPeriodMinutes -= minutesToUse;
                        remainingTaskMinutes -= minutesToUse;

                        if (remainingTaskMinutes <= 0) {
                            taskIndex++;
                            remainingTaskMinutes = taskIndex < taskTimes.length ? taskTimes[taskIndex].minutes : 0;
                        }
                    } else {
                        // minutesToUse が 0 の場合はループを抜ける
                        break;
                    }
                }

                if (loopCounter >= 1000) {
                    console.error("Infinite loop detected in workPeriods.forEach");
                }
            });

            // 休憩時間のセグメントを追加（作業時間の上に重ねて表示）
            breaks.forEach(breakTime => {
                const startPosition = ((breakTime.start - startMinutes) / totalMinutes) * 100;
                const width = ((breakTime.end - breakTime.start) / totalMinutes) * 100;

                const segment = document.createElement('div');
                segment.className = 'time-segment break-segment';
                segment.style.position = 'absolute';
                segment.style.left = startPosition + '%';
                segment.style.width = width + '%';
                segment.style.height = '100%';
                segment.style.zIndex = '10';

                // 休憩終了時刻ラベルのみ
                const endLabel = document.createElement('div');
                endLabel.className = 'time-label';
                endLabel.style.right = '0px';
                endLabel.style.left = 'auto';
                endLabel.style.color = '#666';
                endLabel.style.fontSize = '10px';
                endLabel.textContent = minutesToTime(breakTime.end);
                segment.appendChild(endLabel);

                timeBar.appendChild(segment);
            });
        }

        // 初期設定
        console.log("Starting initialization...");
        try {
            updateVisualization();
            console.log("updateVisualization() completed");
        } catch (error) {
            console.error("Error during initialization:", error);
        }
    </script>
</body>

</html>